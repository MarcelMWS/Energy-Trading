<!doctype html>
<html>

<head>
    <title>OLI SharEnergy</title>
    <script src="web3.js/dist/web3.min.js"></script>

    <script type="text/javascript">

        //OLIOrigin Contract
        var contract_origin_address = "0x06ee5e5254382ed05cC428d2bfCAFc6583413367";
        var contract_origin_abi = [ { "constant": false, "inputs": [ { "name": "oli", "type": "address" }, { "name": "lat", "type": "uint256" }, { "name": "long", "type": "uint256" }, { "name": "area", "type": "uint256" }, { "name": "typex", "type": "uint8" }, { "name": "pload", "type": "uint256" } ], "name": "addOli", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [ { "name": "_account", "type": "address" } ], "name": "get_oliType", "outputs": [ { "name": "", "type": "uint8", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "kill", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [ { "name": "_account", "type": "address" } ], "name": "get_oliAmount", "outputs": [ { "name": "", "type": "uint256", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "_gso", "type": "address" }, { "name": "_area", "type": "uint256" } ], "name": "addGSO", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "paymentAddress", "type": "address" }, { "indexed": false, "name": "latOfLocation", "type": "uint256" }, { "indexed": false, "name": "longOfLocation", "type": "uint256" }, { "indexed": true, "name": "areaCode", "type": "uint256" }, { "indexed": false, "name": "gType", "type": "uint8" }, { "indexed": false, "name": "peakLoad", "type": "uint256" } ], "name": "newAddedOli", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "h_paymentAddress", "type": "address" }, { "indexed": false, "name": "h_latOfLocation", "type": "uint256" }, { "indexed": false, "name": "h_longOfLocation", "type": "uint256" }, { "indexed": false, "name": "h_areaCode", "type": "uint256" }, { "indexed": false, "name": "h_gType", "type": "uint8" }, { "indexed": false, "name": "h_peakLoad", "type": "uint256" } ], "name": "newHarthausenOli", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "s_paymentAddress", "type": "address" }, { "indexed": false, "name": "s_latOfLocation", "type": "uint256" }, { "indexed": false, "name": "s_longOfLocation", "type": "uint256" }, { "indexed": false, "name": "s_areaCode", "type": "uint256" }, { "indexed": false, "name": "s_gType", "type": "uint8" }, { "indexed": false, "name": "s_peakLoad", "type": "uint256" } ], "name": "newStuttgartOli", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "b_paymentAddress", "type": "address" }, { "indexed": false, "name": "b_latOfLocation", "type": "uint256" }, { "indexed": false, "name": "b_longOfLocation", "type": "uint256" }, { "indexed": false, "name": "b_areaCode", "type": "uint256" }, { "indexed": false, "name": "b_gType", "type": "uint8" }, { "indexed": false, "name": "b_peakLoad", "type": "uint256" } ], "name": "newBonnOli", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "u_paymentAddress", "type": "address" }, { "indexed": false, "name": "u_latOfLocation", "type": "uint256" }, { "indexed": false, "name": "u_longOfLocation", "type": "uint256" }, { "indexed": false, "name": "u_areaCode", "type": "uint256" }, { "indexed": false, "name": "u_gType", "type": "uint8" }, { "indexed": false, "name": "u_peakLoad", "type": "uint256" } ], "name": "newUlmOli", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "gsoAddress", "type": "address" }, { "indexed": false, "name": "areaCode", "type": "uint256" } ], "name": "newGso", "type": "event" } ];

        //OLICOin contract
        var contract_Coin_address = "0x3a7BD6665E098eAF4F0DfAFD78642B267cb8D9Bd";
        var contract_Coin_abi = [ { "constant": false, "inputs": [], "name": "withdraw", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [], "name": "kill", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [ { "name": "caddress", "type": "address" } ], "name": "get_coinBalance", "outputs": [ { "name": "", "type": "int256", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "_account", "type": "address" }, { "name": "_change", "type": "int256" } ], "name": "set_OliCoinBalance", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "_value", "type": "uint256" } ], "name": "deposit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" } ];

        //OLIDaughter contract
        var contract_daughter_address = "0xC9833Ae8e1681493d5CbD3F2eca58eCCaE868025";
        var contract_daughter_abi = [ { "constant": false, "inputs": [ { "name": "addr", "type": "address" } ], "name": "setOliOrigin", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "_producer", "type": "address" }, { "name": "_amount", "type": "uint256" }, { "name": "_rate", "type": "uint256" }, { "name": "_period", "type": "uint256" }, { "name": "_consumer", "type": "address" } ], "name": "biTadeMapping", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "addr", "type": "address" } ], "name": "setOliCoin", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [], "name": "kill", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [], "name": "resett", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "y", "type": "uint128" } ], "name": "set_tGridFee", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "_amount", "type": "uint256" }, { "name": "_rate", "type": "uint256" } ], "name": "bid", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "get_producer", "outputs": [ { "name": "", "type": "address[]", "value": [] } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "get_rAmount", "outputs": [ { "name": "", "type": "uint256", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "get_gridFee", "outputs": [ { "name": "", "type": "uint128", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "daccount", "type": "address" }, { "name": "damount", "type": "uint256" }, { "name": "drate", "type": "uint256" } ], "name": "callParentBid", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "get_consumer", "outputs": [ { "name": "", "type": "address[]", "value": [] } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "bidsScaling", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "get_tGridFee", "outputs": [ { "name": "", "type": "uint128", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "get_cAmount", "outputs": [ { "name": "", "type": "uint256", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "getR_Array", "outputs": [ { "name": "", "type": "uint256[]" } ], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [], "name": "getC_Array", "outputs": [ { "name": "", "type": "uint256[]" } ], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "y", "type": "uint128" } ], "name": "set_gridFee", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "get_bValue", "outputs": [ { "name": "", "type": "uint256", "value": "8" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "breakEven", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "addr", "type": "address" } ], "name": "setParentAddress", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "payable": true, "stateMutability": "payable", "type": "fallback" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "gbidder", "type": "address" }, { "indexed": false, "name": "grate", "type": "uint256" }, { "indexed": false, "name": "gamount", "type": "uint256" } ], "name": "NewGenBid", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "cbidder", "type": "address" }, { "indexed": false, "name": "crate", "type": "uint256" }, { "indexed": false, "name": "camount", "type": "uint256" } ], "name": "NewConBid", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "glbidder", "type": "address" }, { "indexed": false, "name": "glrate", "type": "uint256" }, { "indexed": false, "name": "glamount", "type": "uint256" } ], "name": "NewGenLosBid", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "clbidder", "type": "address" }, { "indexed": false, "name": "clrate", "type": "uint256" }, { "indexed": false, "name": "clamount", "type": "uint256" } ], "name": "NewConLosBid", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "cbid", "type": "uint256" }, { "indexed": false, "name": "cbtime", "type": "uint256" } ], "name": "NewMcp", "type": "event" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "bproducer", "type": "address" }, { "indexed": false, "name": "bamount", "type": "uint256" }, { "indexed": false, "name": "brate", "type": "uint256" }, { "indexed": false, "name": "btype", "type": "uint256" }, { "indexed": false, "name": "bperiod", "type": "uint256" }, { "indexed": false, "name": "bconsumer", "type": "address" } ], "name": "NewBiTrade", "type": "event" } ];


        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        var contract_origin_instance = web3.eth.contract(contract_origin_abi).at(contract_origin_address);
        var contract_Coin_instance = web3.eth.contract(contract_Coin_abi).at(contract_Coin_address);
        var contract_daughter_instance = web3.eth.contract(contract_daughter_abi).at(contract_daughter_address);

        var myEvent;

        function watchNewAddedOlis() {

            myEvent = contract_origin_instance.newAddedOli({fromBlock: 'latest' , toBlock:'latest'});
            console.log(myEvent);
            myEvent.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("events_n").innerHTML += "<br />" + "<br />" +
                        "Oli Payment Address: " + result.args.paymentAddress + " | Oli GPS Coordinates: (" + result.args.latOfLocation + "," +
                        result.args.longOfLocation + ") | Oli Area Code: " + result.args.areaCode + " | Connection Details: " + result.args.gType +
                        " | Peak Load:" + result.args.peakLoad;

                }
            });
        }

        function stopWatchingEvents() {
            if(myEvent !== undefined) {
                myEvent.stopWatching();
            }
        }

        function getAllAddedOlis() {
            contract_origin_instance.newAddedOli({}, {fromBlock: 0 , toBlock: 'latest'}).get(function(error, result) {
                if(error) {
                    console.error(error);
                } else {
                    console.log(result);
                    document.getElementById("events_h").innerHTML += "<br />" + "<br />" + JSON.stringify(result);
                }
            });
        }

        function getCoinBalance() {
            x = document.getElementById("numb").value;
            document.getElementById("balance").innerText = contract_Coin_instance.get_coinBalance(x).toNumber();
        }

        var mcp;

        function watchMCP() {

            mcp = contract_daughter_instance.NewMcp({fromBlock: 'latest' , toBlock:'latest'});
            console.log(mcp);
            mcp.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("mcp").innerHTML += "<br />" + "<br />" +
                        "New MCP: " + result.args.cbid + " | MCP Update Time: " + result.args.cbtime;

                }
            });
        }



        function stopWatchingMCP() {
            if(mcp !== undefined) {
                mcp.stopWatching();
            }
        }

        var pbid;

        function watchpbid() {

            pbid = contract_daughter_instance.NewGenBid({fromBlock: 'latest' , toBlock:'latest'});
            console.log(pbid);
            pbid.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("pbid").innerHTML += "<br />" + "<br />" +
                        "Account: " + result.args.gbidder + " | Rate: " + result.args.grate + " | Amount: " + result.args.gamount;

                }
            });
        }



        function stopWatchingpbid() {
            if(pbid !== undefined) {
                pbid.stopWatching();
            }
        }

        var cbid;

        function watchcbid() {

            cbid = contract_daughter_instance.NewConBid({fromBlock: 'latest' , toBlock:'latest'});
            console.log(cbid);
            cbid.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("cbid").innerHTML += "<br />" + "<br />" +
                        "Account: " + result.args.cbidder + " | Rate: " + result.args.crate + " | Amount: " + result.args.camount;

                }
            });
        }



        function stopWatchingcbid() {
            if(cbid !== undefined) {
                cbid.stopWatching();
            }
        }

    </script>

</head>

<body>
<h1>Interact with a contract</h1>

<button onclick="watchNewAddedOlis()">Watch New Oli</button>
<button onclick="stopWatchingEvents()">Stop Watching Event</button>
<button onclick="getAllAddedOlis()">Get All Added Olis</button>
<br />


<input id="numb">

<button type="button" onclick="getCoinBalance()">Submit</button>
<br />
<button onclick="watchMCP()">Watch MCP Update</button>
<button onclick="stopWatchingMCP()">Stop Watching MCP</button>
<br />
<button onclick="watchpbid()">Watch Producers's Bid Update</button>
<button onclick="stopWatchingpbid()">Stop Watching Producers's Bid</button>
<br />
<button onclick="watchcbid()">Watch Consumer's Bid Update</button>
<button onclick="stopWatchingcbid()">Stop Watching Consumer's Bid</button>


<br />
<br />
<h2>New Added Olis:</h2>
<div id="events_n"></div>
<br />
<br />
<h2>Oli History:</h2>
<div id="events_h"></div>
<br />
<br />
<h2>Coin Balance:</h2>
<div id="balance"></div>
<br />
<h2>Producers' Bid:</h2>
<div id="pbid"></div>
<br />
<h2>Consumers' Bid:</h2>
<div id="cbid"></div>
<br />
<h2>Market Clearing Price:</h2>
<div id="mcp"></div>



</body>
</html>