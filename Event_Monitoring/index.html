<!doctype html>
<html>

<head>
    <title>OLI SharEnergy</title>
    <script src="web3.js/dist/web3.min.js"></script>

    <script type="text/javascript">

        //OLIOrigin Contract
        var contract_origin_address = "0x8B47342082d0E2874c289Bb2ee4340a20b5E33a4";
        var contract_origin_abi = [{"constant":false,"inputs":[{"name":"oli","type":"address"},{"name":"lat","type":"uint32"},{"name":"long","type":"uint32"},{"name":"trafo","type":"uint32"},{"name":"ckt","type":"uint8"},{"name":"typex","type":"uint8"},{"name":"pload","type":"uint64[]"}],"name":"addOli","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_account","type":"address"}],"name":"get_oliType","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_account","type":"address"}],"name":"get_oliCkt","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_account","type":"address"}],"name":"get_oliTrafoid","outputs":[{"name":"","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_tid","type":"uint32"}],"name":"get_gsoAddr","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_account","type":"address"},{"name":"_index","type":"uint8"}],"name":"get_oliPeakLoad","outputs":[{"name":"","type":"uint64"}],"payable":false,"stateMutability":"view","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"paymentAddress","type":"address"},{"indexed":false,"name":"latOfLocation","type":"uint32"},{"indexed":false,"name":"longOfLocation","type":"uint32"},{"indexed":true,"name":"trafoid","type":"uint32"},{"indexed":true,"name":"ckt","type":"uint8"}],"name":"newAddedOli","type":"event"}];

        //OLICOin contract
        var contract_Coin_address = "0x06F77Fb2797CA740216cD86711629028d40de3A2";
        var contract_Coin_abi = [ { "constant": false, "inputs": [], "name": "withdraw", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [], "name": "kill", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [ { "name": "caddress", "type": "address" } ], "name": "get_coinBalance", "outputs": [ { "name": "", "type": "int256", "value": "0" } ], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [ { "name": "_account", "type": "address" }, { "name": "_change", "type": "int256" } ], "name": "set_OliCoinBalance", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [ { "name": "_value", "type": "uint256" } ], "name": "deposit", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" } ];

        //OLIDaughter contract
        var contract_daughter_address = "0xd838495d559fe02a0fd1292f13e2094b4165ab5f";
        var contract_daughter_abi = [{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"setOliOrigin","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_amount","type":"uint64"},{"name":"_rate","type":"uint8"}],"name":"bid","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"setBilateralTrading","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"setOliCoin","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"setDynamicGridFee","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"kill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"resett","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"bidsScaling","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"daccount","type":"address"},{"name":"damount","type":"uint64"},{"name":"drate","type":"uint8"}],"name":"callParentBid","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"breakEven","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"addr","type":"address"}],"name":"setParentAddress","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"grate","type":"uint8"},{"indexed":false,"name":"gamount","type":"uint64"}],"name":"NewGenBid","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"crate","type":"uint8"},{"indexed":false,"name":"camount","type":"uint64"}],"name":"NewConBid","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"cbid","type":"uint8"}],"name":"NewMcp","type":"event"}];

        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        var contract_origin_instance = web3.eth.contract(contract_origin_abi).at(contract_origin_address);
        var contract_Coin_instance = web3.eth.contract(contract_Coin_abi).at(contract_Coin_address);
        var contract_daughter_instance = web3.eth.contract(contract_daughter_abi).at(contract_daughter_address);

        var myEvent;

        function watchNewAddedOlis() {

            myEvent = contract_origin_instance.newAddedOli({fromBlock: 'latest' , toBlock:'latest'});
            console.log(myEvent);
            myEvent.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("events_n").innerHTML += "<br />" + "<br />" +
                        "Oli Payment Address: " + result.args.paymentAddress + " | Oli GPS Coordinates: (" + result.args.latOfLocation + "," +
                        result.args.longOfLocation + ") | Oli Area Code: " + result.args.areaCode + " | Connection Details: " + result.args.gType +
                        " | Peak Load:" + result.args.peakLoad;

                }
            });
        }

        function stopWatchingEvents() {
            if(myEvent !== undefined) {
                myEvent.stopWatching();
            }
        }

        function getAllAddedOlis() {
            contract_origin_instance.newAddedOli({}, {fromBlock: 0 , toBlock: 'latest'}).get(function(error, result) {
                if(error) {
                    console.error(error);
                } else {
                    console.log(result);
                    document.getElementById("events_h").innerHTML += "<br />" + "<br />" + JSON.stringify(result);
                }
            });
        }

        function getCoinBalance() {
            x = document.getElementById("numb").value;
            document.getElementById("balance").innerText = contract_Coin_instance.get_coinBalance(x).toNumber();
        }

        var mcp;

        function watchMCP() {

            mcp = contract_daughter_instance.NewMcp({fromBlock: 'latest' , toBlock:'latest'});
            console.log(mcp);
            mcp.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("mcp").innerHTML += "<br />" + "<br />" +
                        "New MCP: " + result.args.cbid;

                }
            });
        }



        function stopWatchingMCP() {
            if(mcp !== undefined) {
                mcp.stopWatching();
            }
        }

        var pbid;

        function watchpbid() {

            pbid = contract_daughter_instance.NewGenBid({fromBlock: 'latest' , toBlock:'latest'});
            console.log(pbid);
            pbid.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("pbid").innerHTML += "<br />" + "<br />" +
                        " | Rate: " + result.args.grate + " | Amount: " + result.args.gamount;

                }
            });
        }



        function stopWatchingpbid() {
            if(pbid !== undefined) {
                pbid.stopWatching();
            }
        }

        var cbid;

        function watchcbid() {

            cbid = contract_daughter_instance.NewConBid({fromBlock: 'latest' , toBlock:'latest'});
            console.log(cbid);
            cbid.watch(function(error, result) {
                if(error) {
                    console.log(error);
                } else {
                    console.log(result);

                    document.getElementById("cbid").innerHTML += "<br />" + "<br />" +
                        " | Rate: " + result.args.crate + " | Amount: " + result.args.camount;

                }
            });
        }



        function stopWatchingcbid() {
            if(cbid !== undefined) {
                cbid.stopWatching();
            }
        }

    </script>

</head>

<body>
<h1>Interact with a contract</h1>

<button onclick="watchNewAddedOlis()">Watch New Oli</button>
<button onclick="stopWatchingEvents()">Stop Watching Event</button>
<button onclick="getAllAddedOlis()">Get All Added Olis</button>
<br />


<input id="numb">

<button type="button" onclick="getCoinBalance()">Submit</button>
<br />
<button onclick="watchMCP()">Watch MCP Update</button>
<button onclick="stopWatchingMCP()">Stop Watching MCP</button>
<br />
<button onclick="watchpbid()">Watch Producers's Bid Update</button>
<button onclick="stopWatchingpbid()">Stop Watching Producers's Bid</button>
<br />
<button onclick="watchcbid()">Watch Consumer's Bid Update</button>
<button onclick="stopWatchingcbid()">Stop Watching Consumer's Bid</button>


<br />
<br />
<h2>New Added Olis:</h2>
<div id="events_n"></div>
<br />
<br />
<h2>Oli History:</h2>
<div id="events_h"></div>
<br />
<br />
<h2>Coin Balance:</h2>
<div id="balance"></div>
<br />
<h2>Producers' Bid:</h2>
<div id="pbid"></div>
<br />
<h2>Consumers' Bid:</h2>
<div id="cbid"></div>
<br />
<h2>Market Clearing Price:</h2>
<div id="mcp"></div>



</body>
</html>